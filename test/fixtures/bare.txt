Simple bare block
.
start

\begin{equation}
2
\end{equation}

end
.
<p>start</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.1600em" columnspacing="1em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mn>2</mn></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
2
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2000000000000002em;vertical-align:-0.35000000000000003em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-2.8499999999999996em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span></span></span></span></p>
<p>end</p>
.

Bare block without newlines
.
start
\begin{equation}
2
\end{equation}
end
.
<p>start<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.1600em" columnspacing="1em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mn>2</mn></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
2
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2000000000000002em;vertical-align:-0.35000000000000003em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-2.8499999999999996em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span></span></span></span></p>
end</p>
.

Bare block with multiple begin/ends
.
start
\begin{equation}
\begin{split}
a = b \\
c = c
\end{split}
\end{equation}
end
.
<p>start<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.1600em" columnspacing="1em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mtable rowspacing="0.2500em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>a</mi><mo>=</mo><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>c</mi><mo>=</mo><mi>c</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
\begin{split}
a = b \\
c = c
\end{split}
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.75em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">b</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.75em;"><span class="pstrut" style="height:3.75em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span></p>
end</p>
.

Should parse not confuse inline $ for bare blockc
.
pre $\begin{equation}
\begin{split}   a &=b+c\\
      &=e+f
\end{split}
\end{equation}$ post
.
<p>pre <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.1600em" columnspacing="1em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mtable rowspacing="0.2500em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>b</mi><mo>+</mo><mi>c</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>e</mi><mo>+</mo><mi>f</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
\begin{split}   a &amp;=b+c\\
      &amp;=e+f
\end{split}
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.75em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">c</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.75em;"><span class="pstrut" style="height:3.75em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span> post</p>
.

Should support single line bare codeblocks
.
Start

\begin{align} \mathbf{A} \end{align}

End
.
<p>Start</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="1.0em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mi mathvariant="bold">A</mi></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} \mathbf{A} \end{align}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style=""></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord mathbf">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span></p>
<p>End</p>
.

Complex begin end calls should match properly for bare blocks
.
before

\begin{gather}
        H(x)=\log{\left(\sqrt{2} \right)}h_1(x)+\log{\left(\frac{\sqrt{15}}{3} \right)}h_2(x)+\log{\left(\frac{\sqrt{21}}{3} \right)}h_3(x)
        \\
         \displaystyle
   h_1(x)=\begin{cases}
    1 \ & \mathrm{if} \  x>=5.5 \\
    -1 \ &\mathrm{if} \  x<5.5
    \end{cases}
    ,\quad \displaystyle
   h_2(x)=\begin{cases}
    -1 \ & \mathrm{if} \  x>=4.5 \\
    1 \ &\mathrm{if} \  x<4.5
    \end{cases}
    ,\quad \displaystyle
   h_3(x)=\begin{cases}
    1 \ & \mathrm{if} \  x>=3.5 \\
    -1 \ &\mathrm{if} \  x<3.5
    \end{cases}
\end{gather}

after
.
<p>before</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="1.0em" columnalign="center" columnspacing="1.0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msqrt><mn>2</mn></msqrt><mo fence="true">)</mo></mrow><msub><mi>h</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><msqrt><mn>15</mn></msqrt><mn>3</mn></mfrac><mo fence="true">)</mo></mrow><msub><mi>h</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><msqrt><mn>21</mn></msqrt><mn>3</mn></mfrac><mo fence="true">)</mo></mrow><msub><mi>h</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mstyle scriptlevel="0" displaystyle=""><msub><mi>h</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="1.0em" columnalign="left left" columnspacing="1.0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mn>1</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>x</mi><mo>&gt;</mo><mo>=</mo><mn>5.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mo>−</mo><mn>1</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>x</mi><mo>&lt;</mo><mn>5.5</mn></mrow></mstyle></mtd></mtr></mtable></mrow><mo separator="true">,</mo><mspace width="1.0em"/><mstyle scriptlevel="0" displaystyle=""><msub><mi>h</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="1.0em" columnalign="left left" columnspacing="1.0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mo>−</mo><mn>1</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>x</mi><mo>&gt;</mo><mo>=</mo><mn>4.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mn>1</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>x</mi><mo>&lt;</mo><mn>4.5</mn></mrow></mstyle></mtd></mtr></mtable></mrow><mo separator="true">,</mo><mspace width="1.0em"/><mstyle scriptlevel="0" displaystyle=""><msub><mi>h</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="1.0em" columnalign="left left" columnspacing="1.0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mn>1</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>x</mi><mo>&gt;</mo><mo>=</mo><mn>3.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mo>−</mo><mn>1</mn><mtext> </mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>x</mi><mo>&lt;</mo><mn>3.5</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mstyle></mstyle></mstyle></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{gather}
        H(x)=\log{\left(\sqrt{2} \right)}h_1(x)+\log{\left(\frac{\sqrt{15}}{3} \right)}h_2(x)+\log{\left(\frac{\sqrt{21}}{3} \right)}h_3(x)
        \\
         \displaystyle
   h_1(x)=\begin{cases}
    1 \ &amp; \mathrm{if} \  x&gt;=5.5 \\
    -1 \ &amp;\mathrm{if} \  x&lt;5.5
    \end{cases}
    ,\quad \displaystyle
   h_2(x)=\begin{cases}
    -1 \ &amp; \mathrm{if} \  x&gt;=4.5 \\
    1 \ &amp;\mathrm{if} \  x&lt;4.5
    \end{cases}
    ,\quad \displaystyle
   h_3(x)=\begin{cases}
    1 \ &amp; \mathrm{if} \  x&gt;=3.5 \\
    -1 \ &amp;\mathrm{if} \  x&lt;3.5
    \end{cases}
\end{gather}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style=""></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord mathnormal" style="">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="mop">lo<span style="">g</span></span><span class="mspace" style=""></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size2">(</span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span class="svg-align" style=""><span class="pstrut" style=""></span><span class="mord" style=""><span class="mord">2</span></span></span><span style=""><span class="pstrut" style=""></span><span class="hide-tail" style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="mclose delimcenter" style=""><span class="delimsizing size2">)</span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mbin">+</span><span class="mspace" style=""></span><span class="mop">lo<span style="">g</span></span><span class="mspace" style=""></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">3</span></span></span><span style=""><span class="pstrut" style=""></span><span class="frac-line" style=""></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span class="svg-align" style=""><span class="pstrut" style=""></span><span class="mord" style=""><span class="mord">15</span></span></span><span style=""><span class="pstrut" style=""></span><span class="hide-tail" style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style=""><span class="delimsizing size4">)</span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mbin">+</span><span class="mspace" style=""></span><span class="mop">lo<span style="">g</span></span><span class="mspace" style=""></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">3</span></span></span><span style=""><span class="pstrut" style=""></span><span class="frac-line" style=""></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span class="svg-align" style=""><span class="pstrut" style=""></span><span class="mord" style=""><span class="mord">21</span></span></span><span style=""><span class="pstrut" style=""></span><span class="hide-tail" style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style=""><span class="delimsizing size4">)</span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">1</span><span class="mspace"> </span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">−</span><span class="mord">1</span><span class="mspace"> </span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="arraycolsep" style=""></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathrm" style="">if</span></span><span class="mspace"> </span><span class="mord mathnormal">x</span><span class="mspace" style=""></span><span class="mrel">&gt;=</span><span class="mspace" style=""></span><span class="mord">5.5</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathrm" style="">if</span></span><span class="mspace"> </span><span class="mord mathnormal">x</span><span class="mspace" style=""></span><span class="mrel">&lt;</span><span class="mspace" style=""></span><span class="mord">5.5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style=""></span><span class="mpunct">,</span><span class="mspace" style=""></span><span class="mspace" style=""></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">−</span><span class="mord">1</span><span class="mspace"> </span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">1</span><span class="mspace"> </span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="arraycolsep" style=""></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathrm" style="">if</span></span><span class="mspace"> </span><span class="mord mathnormal">x</span><span class="mspace" style=""></span><span class="mrel">&gt;=</span><span class="mspace" style=""></span><span class="mord">4.5</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathrm" style="">if</span></span><span class="mspace"> </span><span class="mord mathnormal">x</span><span class="mspace" style=""></span><span class="mrel">&lt;</span><span class="mspace" style=""></span><span class="mord">4.5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style=""></span><span class="mpunct">,</span><span class="mspace" style=""></span><span class="mspace" style=""></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">1</span><span class="mspace"> </span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">−</span><span class="mord">1</span><span class="mspace"> </span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="arraycolsep" style=""></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathrm" style="">if</span></span><span class="mspace"> </span><span class="mord mathnormal">x</span><span class="mspace" style=""></span><span class="mrel">&gt;=</span><span class="mspace" style=""></span><span class="mord">3.5</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathrm" style="">if</span></span><span class="mspace"> </span><span class="mord mathnormal">x</span><span class="mspace" style=""></span><span class="mrel">&lt;</span><span class="mspace" style=""></span><span class="mord">3.5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="eqn-num"></span></span><span style=""><span class="pstrut" style=""></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span></p>
<p>after</p>
.

Bare block with \begin and \end in line
.
\begin{equation}
\mathbf{Ha}=\begin{bmatrix}\alpha\\0\\\vdots\\0\end{bmatrix}=\alpha\begin{bmatrix}1\\0\\\vdots\\0\end{bmatrix}=\alpha\mathbf{e}_1
\end{equation}

x $\mathbf{H}$ y
.
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="1.0em" columnspacing="1.0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mrow><mi mathvariant="bold">H</mi><mi mathvariant="bold">a</mi></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="1.0em" columnalign="center" columnspacing="1.0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mi>α</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mi mathvariant="normal">⋮</mi><mpadded height="1.0em" voffset="1.0em"><mspace mathbackground="black" width="1.0em" height="1.0em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mi>α</mi><mrow><mo fence="true">[</mo><mtable rowspacing="1.0em" columnalign="center" columnspacing="1.0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mi mathvariant="normal">⋮</mi><mpadded height="1.0em" voffset="1.0em"><mspace mathbackground="black" width="1.0em" height="1.0em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mi>α</mi><msub><mi mathvariant="bold">e</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
\mathbf{Ha}=\begin{bmatrix}\alpha\\0\\\vdots\\0\end{bmatrix}=\alpha\begin{bmatrix}1\\0\\\vdots\\0\end{bmatrix}=\alpha\mathbf{e}_1
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style=""></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord mathbf">Ha</span></span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord mathnormal" style="">α</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">0</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style=""></span></span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="mord mathnormal" style="">α</span><span class="mspace" style=""></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">1</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">0</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style=""></span></span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span style=""><svg></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="mord mathnormal" style="">α</span><span class="mord"><span class="mord mathbf">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span></p>
<p>x <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">H</mi></mrow><annotation encoding="application/x-tex">\mathbf{H}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style=""></span><span class="mord mathbf">H</span></span></span></span> y</p>
.

Bare block with non blank previous line https://github.com/microsoft/vscode/issues/202149
.
Consider
\begin{equation}
f(x) = \begin{cases}
1 & \text{if ...} \\
1 & \text{otherwise}
\end{cases}
\end{equation}
.
<p>Consider<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="1.0em" columnspacing="1.0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="1.0em" columnalign="left left" columnspacing="1.0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mtext>if ...</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle=""><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle=""><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
f(x) = \begin{cases}
1 &amp; \text{if ...} \\
1 &amp; \text{otherwise}
\end{cases}
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style=""></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord mathnormal" style="">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style=""></span><span class="mrel">=</span><span class="mspace" style=""></span><span class="minner"><span class="mopen delimcenter" style=""><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">1</span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span><span class="arraycolsep" style=""></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord text"><span class="mord">if ...</span></span></span></span><span style=""><span class="pstrut" style=""></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style=""><span style=""><span class="pstrut" style=""></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style=""><span></span></span></span></span></span></span></span></span></p>
</p>
.